<html>

<head>
    <title>Galen Guyer | Code of Conduct</title>
    <meta charset="utf-8" />
    <meta name="description" content="A standard Code of Conduct for services I maintain.">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <noscript>
        <link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>
    <style>
        code {
            white-space: nowrap;
        }

    </style>
</head>

<body class="is-preload">

    <!-- Page Wrapper -->
    <div id="page-wrapper">

        <!-- Header -->
        <header id="header">
            <h1><a href="/">Galen Guyer</a></h1>
            <nav>
                <a href="#menu">Menu</a>
            </nav>
        </header>

        <!-- Menu -->
        {{MENU}}


        <!-- Wrapper -->
        <section id="wrapper">
            <header>
                <div class="inner">
                    <h2>Jensen Belongs to the Nords</h2>
                    <h3>Or why testing123456 is a bad password</h3>

                </div>
            </header>

            <!-- Content -->
            <div class="wrapper">
                <div class="inner">
                    <h3 id="summary">Summary</h3>

                    <p>On Thursday, Jan 23, Datadog reported high CPU usage for Jensen. I was running some stuff on it at the time so was wondering if my job was causing the high usage. <code>htop</code> showed some impact by my job, with the majority if CPU usage being a script or executable called <code>./cron</code> run by user <code>testing</code>. I remarked on the high CPU usage at the time but assumed it was an RTP testing something. This was later recognized as being not the case, leading to jensen being shut down and wiped.</p>

                    <h3 id="impact">Impact</h3>

                    <p>Nine remote connections to the testing account on jensen were logged. The primary attack, which we noticed, was a 3 part attack: A bitcoin miner (which threw the CPU usage warning), a perl script, and a bruteforcing binary. This attack likely had no impact on user data. The impacts of the other connections are unknown at this time.</p>

                    <h3 id="what-happened">What Happened</h3>

                    <p>The malware left several files behind in the <code>/users/u99/testing</code> and <code>/tmp</code>, as well as altering the testing user&#39;s crontab. Unsurprisingly, <code>~/.bash_history</code> is empty, and won&#39;t provide any clues as to what happened. The first notable modification by the malware is adding a public key to ~testing/.ssh/authorized_keys. This key had the comment <code>mdrfckr</code>. When googled, the first result for this word is a post on the Ubuntu forums[1] with the same public key as we had. The second result is about a cron job taking up 100% of CPU usage on an Ubuntu 18 server[2]. Both posts were several months to a year old but matched what happened. There was also a <code>cron.d</code> file in the homedir of the testing user[3], which contained some odd lines. These lines were very similar to ones found in both posts and pointed to a few files and folders. Looking into these folders provided some more clues</p>

                    <p>The first folder pointed to by the crontab on our machine was <code>~testing/.bashtemp/a</code>. <code>.bashtemp</code>, starting with a <code>.</code> (period), is hidden from normal ls, and we see this being a common trend with other folders used by this malware. <code>ls -a</code> will show these hidden folders. Inspecting <code>~testing/.bashtemp/a</code> shows two ELF binaries and four shell scripts. One of those binaries is named <code>cron</code>, the same name as the original suspicious process. Seeing as this was a common infection, I uploaded the cron binary to virustotal.com. Virustotal quickly recognized it[4] as a Bitcoin miner. Some also recognized it as a trojan. Virustotal also linked to a report from joesandbox.com[5], which also classified it as a miner/trojan. The other binary in the folder, named anacron, was classified the same, with the other files being shell scripts used to set up and run the miner. </p>

                    <p>The next folder to look at was <code>~testing/.bashtemp/b</code>. This contained 4 shells scripts, 3 of which looked similar with the purpose of setting up and running the file run. This file was a bit of an anomaly. The last line is the one that set the ssh key we found by forcibly removing the <code>~/.ssh</code> folder and adding the mdrfckr key as the only allowed key. This is presumably to make it harder for administrators to access the server and would be effective on a single-user machine that only allows public key login, however that wasn&#39;t an issue given the nature of jensen. It also contained a large block of base64 text, which it then decoded and passed to perl. Decoding this base64 showed an exec call to a obfuscated perl script. I&#39;ve deobfuscated the script but haven&#39;t gone through it yet. Windows Defender really doesn&#39;t like me saving it, though.</p>
                    <p>The last place pointed to by the crontab was <code>/tmp/.X19-unix/</code>. This folder name varies the most among reports of similar malware but the <code>/tmp/.X[NUBMER]-unix</code> trend matches. This contained the hidden folder <code>.rsync</code> as well as a file called <code>dota3.tar.gz</code>, which just contained the compressed contents of the <code>.rsync</code> folder. The <code>.rsync</code> folder contained a few setup scripts similar to what we saw earlier as well as 3 folders, named <code>a</code>, <code>b</code>, and <code>c</code>. <code>a</code> and <code>b</code> had similar contents to the ones we saw in testing&#39;s homedir, but the <code>c</code> folder is new. The contents are familar, several setup scripts and some binaries. These binaries are new and follow a naming trend. The setup scripts show that each binary is the same program, just compiled for different architectures. The setup scripts select and run the one for the current architecture. Virustotal reports these binaries as backdoor/bruteforce programs, which matches a report by trendmicro.com[6], who report similar file structures and names.</p>

                    <p>Once I had a decent understanding of the files on jensen, I looked through the authentication logs to try to find where the attacker was coming from. There was a theory that the public key we found was left over from when 24ball was compromized, but several things indicate this to not be the case. First off, the scripts found in <code>~/.bashtemp/b</code> are responsible for overwriting all keys in <code>~/.ssh/authorized_keys</code> and replacing them with its own. The key found in <code>~/.ssh/authorized_keys</code> matches the key found in the script. Furthermore, I inspected the authentication logs and found nine password logins for the user testing in the past 14 days[7] (Since January 13). There are no logins since Jan. 13 to the testing user using an SSH key. The exploitation of a weak password is further backed up by the fact jensen doesn&#39;t mount ceph - even if a publickey was dropped on 24ball when it was compromised, jensen wouldn&#39;t have that key. </p>
                    <p>Out of the nine connections, there was one that seems likely to be the one that introduced the malware we noticed. I was able to correlate these by checking the file creation time of the <code>dota3.tar.gz</code> file, which <code>ls -l</code> reported to be <code>Jan 19 23:53</code>. The last connection we logged was initiated at <code>Jan 19 23:53:29</code> and lasted for under 1 second. The originating IP points to a server from a small provider in the Netherlands. The server is not responding on any port now. The other IPs point to Indonesia, Vietnam, Singapore, and New Jersey and all respond on various standard ports.</p>

                </div>
            </div>

        </section>

        <!-- Footer -->
        {{FOOTER}}

    </div>

    <!-- Scripts -->
    {{SCRIPTS}}
</body>

</html>
